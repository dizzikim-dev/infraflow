/**
 * VulnerabilityPanel Component Tests
 */

import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { VulnerabilityPanel } from '@/components/panels/VulnerabilityPanel';
import type { InfraSpec } from '@/types/infra';

// Mock framer-motion
vi.mock('framer-motion', () => ({
  motion: {
    div: ({ children, ...props }: Record<string, unknown>) => {
      const { initial, animate, exit, ...rest } = props;
      return <div {...rest}>{children as React.ReactNode}</div>;
    },
  },
}));

const mockSpec: InfraSpec = {
  nodes: [
    { id: 'fw-1', type: 'firewall', label: 'Firewall' },
    { id: 'web-1', type: 'web-server', label: 'Web Server' },
    { id: 'db-1', type: 'db-server', label: 'DB Server' },
  ],
  connections: [],
};

describe('VulnerabilityPanel', () => {
  it('should render panel header', () => {
    const onClose = vi.fn();
    render(<VulnerabilityPanel spec={mockSpec} onClose={onClose} />);
    expect(screen.getByText('보안 취약점')).toBeDefined();
  });

  it('should show empty state when spec is null', () => {
    const onClose = vi.fn();
    render(<VulnerabilityPanel spec={null} onClose={onClose} />);
    expect(screen.getByText('다이어그램을 먼저 생성해주세요.')).toBeDefined();
  });

  it('should display vulnerability cards for matching components', () => {
    const onClose = vi.fn();
    render(<VulnerabilityPanel spec={mockSpec} onClose={onClose} />);
    // Should show firewall, web-server, and db-server vulnerabilities
    expect(screen.getAllByText('CRITICAL').length).toBeGreaterThan(0);
  });

  it('should display filter tabs', () => {
    const onClose = vi.fn();
    render(<VulnerabilityPanel spec={mockSpec} onClose={onClose} />);
    expect(screen.getByText('전체')).toBeDefined();
    expect(screen.getByText('Critical')).toBeDefined();
    expect(screen.getByText('High')).toBeDefined();
    expect(screen.getByText('Medium+')).toBeDefined();
  });

  it('should filter vulnerabilities when tab is clicked', () => {
    const onClose = vi.fn();
    render(<VulnerabilityPanel spec={mockSpec} onClose={onClose} />);

    // Click Critical tab
    fireEvent.click(screen.getByText('Critical'));
    // All visible severity badges should be CRITICAL
    const badges = screen.getAllByText('CRITICAL');
    expect(badges.length).toBeGreaterThan(0);
  });

  it('should call onClose when close button is clicked', () => {
    const onClose = vi.fn();
    render(<VulnerabilityPanel spec={mockSpec} onClose={onClose} />);
    const closeBtn = screen.getByLabelText('닫기');
    fireEvent.click(closeBtn);
    expect(onClose).toHaveBeenCalledOnce();
  });

  it('should show CVE IDs when present', () => {
    const onClose = vi.fn();
    render(<VulnerabilityPanel spec={mockSpec} onClose={onClose} />);
    // Firewall has CVE-2024-3400
    expect(screen.getByText('CVE-2024-3400')).toBeDefined();
  });

  it('should show footer with summary', () => {
    const onClose = vi.fn();
    render(<VulnerabilityPanel spec={mockSpec} onClose={onClose} />);
    expect(screen.getByText(/출처: NVD, MITRE CVE/)).toBeDefined();
  });

  it('should handle spec with no matching vulnerabilities', () => {
    const onClose = vi.fn();
    const spec: InfraSpec = {
      nodes: [{ id: 'sdwan-1', type: 'sd-wan', label: 'SD-WAN' }],
      connections: [],
    };
    render(<VulnerabilityPanel spec={spec} onClose={onClose} />);
    expect(screen.getByText('알려진 취약점이 없습니다.')).toBeDefined();
  });
});
