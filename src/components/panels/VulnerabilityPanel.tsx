'use client';

/**
 * Vulnerability Panel Component
 *
 * Displays curated CVE/vulnerability warnings for components in the current diagram.
 * Tabs: All / Critical / High / Medium+Low
 */

import { useState, useMemo } from 'react';
import { ShieldAlert, AlertTriangle, CheckCircle2 } from 'lucide-react';
import type { InfraSpec } from '@/types';
import { useVulnerabilities } from '@/hooks/useVulnerabilities';
import type { CVESeverity, VulnerabilityEntry } from '@/lib/knowledge/vulnerabilities';
import { PanelContainer } from './PanelContainer';
import { PanelHeader } from './PanelHeader';
import { PanelTabs } from './PanelTabs';

// ============================================================
// Types
// ============================================================

interface VulnerabilityPanelProps {
  spec: InfraSpec | null;
  onClose: () => void;
}

type FilterTab = 'all' | 'critical' | 'high' | 'medium-low';

// ============================================================
// Component
// ============================================================

export function VulnerabilityPanel({ spec, onClose }: VulnerabilityPanelProps) {
  const [activeFilter, setActiveFilter] = useState<FilterTab>('all');
  const { vulnerabilities, criticalCount, highCount, stats } = useVulnerabilities(spec);

  const mediumLowCount = stats.medium + stats.low;

  const filtered = useMemo(() => {
    switch (activeFilter) {
      case 'critical':
        return vulnerabilities.filter((v) => v.severity === 'critical');
      case 'high':
        return vulnerabilities.filter((v) => v.severity === 'high');
      case 'medium-low':
        return vulnerabilities.filter((v) => v.severity === 'medium' || v.severity === 'low');
      default:
        return vulnerabilities;
    }
  }, [vulnerabilities, activeFilter]);

  const tabs: { key: FilterTab; label: string; count: number }[] = [
    { key: 'all', label: 'ì „ì²´', count: vulnerabilities.length },
    { key: 'critical', label: 'Critical', count: criticalCount },
    { key: 'high', label: 'High', count: highCount },
    { key: 'medium-low', label: 'Medium+', count: mediumLowCount },
  ];

  return (
    <PanelContainer>
      <PanelHeader icon={ShieldAlert} iconColor="text-red-400" title="ë³´ì•ˆ ì·¨ì•½ì " onClose={onClose} />

      {/* Filter Tabs */}
      <PanelTabs
        tabs={tabs}
        active={activeFilter}
        onChange={setActiveFilter}
        activeClassName="text-red-400 border-b-2 border-red-400 bg-red-500/10"
        activeBadgeClassName="bg-red-500/20 text-red-300"
      />

      {/* Content */}
      <div className="flex-1 overflow-y-auto p-4 space-y-3">
        {!spec && (
          <div className="text-center text-zinc-500 py-12">
            <AlertTriangle className="w-10 h-10 mx-auto mb-3 opacity-50" />
            <p>ë‹¤ì´ì–´ê·¸ë¨ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.</p>
          </div>
        )}

        {spec && filtered.length === 0 && (
          <div className="text-center text-zinc-500 py-12">
            <CheckCircle2 className="w-10 h-10 mx-auto mb-3 text-green-500/50" />
            <p>{activeFilter === 'all' ? 'ì•Œë ¤ì§„ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤.' : 'í•´ë‹¹ ì‹¬ê°ë„ì˜ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
          </div>
        )}

        {spec && filtered.map((vuln) => (
          <VulnerabilityCard key={vuln.id} vuln={vuln} />
        ))}
      </div>

      {/* Footer */}
      {spec && (
        <div className="border-t border-white/10 px-4 py-3 text-xs text-zinc-400">
          <div className="flex items-center justify-between">
            <span>
              ì´ {vulnerabilities.length}ê°œ ì·¨ì•½ì 
              {criticalCount > 0 && <span className="text-red-400 ml-1">(Critical: {criticalCount})</span>}
              {highCount > 0 && <span className="text-orange-400 ml-1">(High: {highCount})</span>}
            </span>
            <span className="text-zinc-500">ì¶œì²˜: NVD, MITRE CVE</span>
          </div>
        </div>
      )}
    </PanelContainer>
  );
}

// ============================================================
// Sub-components
// ============================================================

function VulnerabilityCard({ vuln }: { vuln: VulnerabilityEntry }) {
  const severityConfig = getSeverityConfig(vuln.severity);

  return (
    <div className="bg-zinc-800/50 rounded-lg p-3 border border-white/5">
      <div className="flex items-start gap-2">
        <span className="mt-0.5">{severityConfig.icon}</span>
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 flex-wrap">
            <span className={`text-xs font-mono px-1.5 py-0.5 rounded ${severityConfig.badgeClass}`}>
              {vuln.severity.toUpperCase()}
            </span>
            {vuln.cveId && (
              <span className="text-xs font-mono px-1.5 py-0.5 rounded bg-zinc-700 text-zinc-300">
                {vuln.cveId}
              </span>
            )}
            {vuln.cvssScore !== undefined && (
              <span className="text-xs text-zinc-500">CVSS: {vuln.cvssScore}</span>
            )}
          </div>
          <p className="text-sm font-medium text-white mt-1.5">{vuln.titleKo}</p>
          <p className="text-xs text-zinc-400 mt-1">{vuln.descriptionKo}</p>

          {/* Affected components */}
          <div className="flex flex-wrap gap-1 mt-2">
            {vuln.affectedComponents.map((comp) => (
              <span key={comp} className="text-[10px] px-1.5 py-0.5 rounded bg-zinc-700/50 text-zinc-400">
                {comp}
              </span>
            ))}
          </div>

          {/* Mitigation */}
          <div className="mt-2 p-2 rounded bg-blue-500/5 border border-blue-500/10">
            <p className="text-xs text-blue-300">
              <span className="text-zinc-500">ëŒ€ì‘:</span> {vuln.mitigationKo}
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

function getSeverityConfig(severity: CVESeverity) {
  switch (severity) {
    case 'critical':
      return { icon: 'ğŸ”´', badgeClass: 'bg-red-500/20 text-red-300' };
    case 'high':
      return { icon: 'ğŸŸ ', badgeClass: 'bg-orange-500/20 text-orange-300' };
    case 'medium':
      return { icon: 'ğŸŸ¡', badgeClass: 'bg-yellow-500/20 text-yellow-300' };
    case 'low':
      return { icon: 'ğŸŸ¢', badgeClass: 'bg-green-500/20 text-green-300' };
  }
}
